<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Search Tester</title>
    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <!-- Custom styles for this template -->
  </head>
  <body>
    <div class="container">
      <div id="mainsearch" class="row">
        <div class="col-md-8">
          <h2>Your Initial PubMed search</h2>
          <form class="form-inline">
          <div class="form-group mb-2">
            <input type="text" class="form-control" id="search">
          </div>
          <button id="runsearch" class="btn btn-primary mb-2" type="button">Search</button>
        </form>
        Minimum number of "good" articles to select:
        <select id="minimumgood">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="40">40</option>
        </select>
        </div>
      </div>
      <hr>
    </div>

    <div id="lists" class="container">
      <div class="row">
        <div class="col-md-3">
          <h4>Unsorted documents: <span id="mehnumber"></h4>
            <a data-toggle="collapse" href="#sievelist" aria-expanded="false" aria-controls="collapseExample">
              Show all
            </a>
          <ul class="collapse" id="sievelist">
          </ul>
        </div>
        <div class="col-md-3">
          <h4>"Good" documents: <span id="goodnumber">0</h4>
            <a data-toggle="collapse" href="#goodlist" aria-expanded="false" aria-controls="collapseExample">
              Show all
            </a>
          <ul class="collapse" id="goodlist">
          </ul>
        </div>
        <div class="col-md-3">
          <h4>"Bad" documents: <span id="badnumber">0</h4>
            <a data-toggle="collapse" href="#badlist" aria-expanded="false" aria-controls="collapseExample">
              Show all
            </a>
          <ul class="collapse" id="badlist">
          </ul>
        </div>
        <div class="col-md-3">
          <h4>Skipped documents: <span id="skipnumber">0</h4>
            <a data-toggle="collapse" href="#skippedlist" aria-expanded="false" aria-controls="collapseExample">
              Show all
            </a>
          <ul class="collapse" id="skippedlist">
          </ul>
        </div>
      </div>
      <button type="button" id="starttest" class="btn btn-primary">Start testing</button>
      <button type="button" id="fetchmore" class="btn btn-outline-secondary">Try sorting more</button>
      <hr>

    </div>

    <div id="results" class="container">
      <div class="row">
        <div class="col-md-8">
        <table class="table table-striped" id="searchperformance">
          <tr>
            <th scope="col">Search</th>
            <th scope="col">Number screened</th>
            <th scope="col">Good cites (Ratio)</th>
            <th scope="col">Bad cites (Ratio)</th>
          </tr>
          <tr>
            <th colspan=4>Initial Search</th>
          </tr>
        </table>
      </div>
      </div>
      <div id="nextsearch" class="row">
        <div class="col-md-8">
          <h2>Refine your search</h2>
          <form class="form-inline">
          <div class="form-group mb-2">
            <input type="text" class="form-control" id="refinesearch">
          </div>
        <button type="button" id="testversion" class="btn btn-primary">Test this version</button>
      </form>
      </div>
    </div>
  </div>



    <div id="judge-doc" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Curent status: <span id="currentstatus"></span></h4>
          </div>
          <div id="doc-display" class="modal-body">
          </div>
          <div class="modal-footer">
              <button type="button" id="markbad" class="btn btn btn-danger">← Bad</button>
              <button type="button" id="markmeh" class="btn btn-light">↑ Skip</button>
              <button type="button" id="markgood" class="btn btn-success">→ Good</button>
        </div>
        </div>
      </div>
    </div>
  </body>
  <script>

  (function() {

  var startDocs = {};
  var pausetime = performance.now();
  var startWebEnv;
  var startCount;
  var goodWebEnv;
  var badWebEnv;
  var skipWebEnv;
  var searches = {};
  var searchcount;
  var sieveDocs = [];
  var skipDocs = [];
  var goodDocs = [];
  var badDocs = [];




  $("#lists").hide();
  $("#results").hide();

  $(document).keydown(function(e) {
    if(e.keyCode == 13) {
      //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
      e.preventDefault();
      if($('#mainsearch').is(':visible')){
        $( "#runsearch" ).trigger( "click" );
      }
      if($('#nextsearch').is(':visible')){
        $( "#testversion" ).trigger( "click" );
      }
    }
  });

  $("#judge-doc").keydown(function(e) {
    if(e.key == "ArrowLeft") {
      $( "#markbad" ).trigger( "click" );
    }
    if(e.key == "ArrowUp") {
      $( "#markmeh" ).trigger( "click" );
    }
    if(e.key == "ArrowRight") {
      $( "#markgood" ).trigger( "click" );
    }
  });

  $("#runsearch").click(function(){
     $("#mainsearch").hide();
     $("#lists").show();
     var searchstr = $("#search").val();
     startSearch(searchstr);
   });

   $("#fetchmore").click(function(){
     getDoc(20);
     fetchunsorted();
    });

   $( "#lists" ).on( "click", "li", function() {
     var selecteddoc = $(this).attr("data-pmid");
     showDoc(selecteddoc);
   });

   $("#starttest").click(function(){
      $("#lists").hide;
      epost(goodDocs)
      .done(function( xml ) {
        $(xml).find('ePostResult').each(function(){
          goodWebEnv = $(this).find("WebEnv").text();
          console.log(goodWebEnv);
        });
      });
      epost(badDocs)
      .done(function( xml ) {
        $(xml).find('ePostResult').each(function(){
          badWebEnv = $(this).find("WebEnv").text();
        });
      });
      if (skipDocs.length > 0) {
        epost(skipDocs)
        .done(function( xml ) {
          $(xml).find('ePostResult').each(function(){
            skipWebEnv = $(this).find("WebEnv").text();
          });
        });
      }
      $("#lists").hide();
      $("#results").show();
      var searchstr = $("#search").val();
      var totalsorted = goodDocs.length + badDocs.length + skipDocs.length;
      searches["start"] = { "search": searchstr, "screened": totalsorted, "good": goodDocs.length, "bad": badDocs.length };
      writeResults(searchstr, totalsorted, goodDocs.length, badDocs.length);
      searchcount = 0;
    });

    $("#testversion").click(function(){
      var searchstr = $("#refinesearch").val();
      var rowcount = $('table tr').length;
      console.log(rowcount);
      var goodhits;
      var badhits;
      var skiphits;
      testsearch(goodWebEnv, searchstr)
      .then(function( data ) {
        goodhits = Number(data.esearchresult.count);
        testsearch(badWebEnv, searchstr)
        .then(function( data ) {
          badhits = Number(data.esearchresult.count);
          testsearch(skipWebEnv, searchstr)
          .then(function( data ) {
            skiphits = Number(data.esearchresult.count) || 0;
            searchcount = searchcount + 1;
            var totalsorted = goodhits + badhits + skiphits;
            searches[searchcount] = { "search": searchstr, "screened": totalsorted, "good": goodhits, "bad": badhits };
            writeResults(searchstr, totalsorted, goodhits, badhits);
          });
        });
      });
     });

   $("#judge-doc button").click(function(){
     var mingood = $( "#minimumgood option:selected" ).val();
     if (goodDocs.length >= mingood) {
       $("#judge-doc").modal('hide');
       alert("All sorted!");
     } else {
       var selecteddoc = $( "#judge-doc .doctitle" ).attr("data-pmid");
       if ($(this).attr("id") == "markgood") { startDocs[selecteddoc].sortstatus = "Good" }
       if ($(this).attr("id") == "markmeh") { startDocs[selecteddoc].sortstatus = "Skipped" }
       if ($(this).attr("id") == "markbad") { startDocs[selecteddoc].sortstatus = "Bad" }
       if (sieveDocs.length < 3) {
         getDoc(10);
       }
       updateLists();
       fetchunsorted();
     }
    });

   function startSearch(term) {
     esearch(term)
     .then(function( data ) {
       startWebEnv = data.esearchresult.webenv;
       startCount = data.esearchresult.count;
       getDoc(40);
       fetchunsorted();
     });
   }

   function epost(array) {
      ids = array.join(',');
      return $.ajax({
        url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi',
        data: {
          db: 'pubmed',
          id: ids,
          email: 'ed_sperr@hotmail.com',
          tool: 'searchtest',
          api_key: 'f069cf776feaa627ab9b1e0fc2b090610708'
        }
        });
   }

   function esearch(term) {
      pausetime = performance.now();
      return $.ajax({
        url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
        data: {
          db: 'pubmed',
          usehistory: 'y',
          term: term,
          retmode: 'json',
          retmax: 0,
          email: 'ed_sperr@hotmail.com',
          tool: 'searchtest',
          api_key: 'f069cf776feaa627ab9b1e0fc2b090610708'
        }
        });
   }

   function testsearch(webenv, term) {
    console.log("fired!");
    return $.ajax({
        url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
        data: {
          db: 'pubmed',
          usehistory: 'y',
          term: term,
          query_key: 1,
          WebEnv: webenv,
          rettype: 'uilist',
          retmode: 'json',
          email: 'ed_sperr@hotmail.com',
          tool: 'searchtest',
          api_key: 'f069cf776feaa627ab9b1e0fc2b090610708'
        }
      });
   }

   function efetch(index) {
      pausetime = performance.now();
      return $.ajax({
        url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi',
        data: {
          db: 'pubmed',
          retstart: index,
          retmax: 1,
          query_key: 1,
          WebEnv: startWebEnv,
          retmode: 'xml',
          rettype: 'abstract',
          email: 'ed_sperr@hotmail.com',
          tool: 'searchtest',
          api_key: 'f069cf776feaa627ab9b1e0fc2b090610708'
        }
      });
   }

   function getDoc(numrequired) {
     var indexes = [];
     var currentmeh = Number($("#mehnumber").text());
     $("#mehnumber").text(currentmeh + numrequired);
     for (i = 0; i < numrequired; i++) {
       var index = getRandomIntInclusive(1, startCount);
       indexes.push(index);
     }
     var uniqueindexes = indexes.filter( onlyUnique );
     for (i = 0; i < numrequired; i++)  {
       checktime();
       function checktime() {
         var t1 = performance.now();
         var timediff = t1 - pausetime;
         if (timediff > 500) {
           callutils();
         } else {
           setTimeout(checktime, 50);
         }
       }
       function callutils() {
         var myDoc = {};
         var index = indexes.pop();
         efetch(index)
         .done(function( xml ) {
           var authors = [];
           $(xml).find('PubmedArticle').each(function(){
             myDoc.pmid = $(this).find("PMID:first").text();
             if (startDocs[myDoc.pmid]) {
               console.log("We already have this one...")
             } else {
               myDoc.title = $(this).find("ArticleTitle").text();
               myDoc.abstract = $(this).find("AbstractText").text();
               var journal = $(this).find("Journal");
               myDoc.journalTitle = journal.find("Title").text();
               var journalIssue = journal.find("JournalIssue");
               myDoc.volume = journalIssue.find("Volume").text();
               myDoc.issue = journalIssue.find("Issue").text();
               var journalDate = journalIssue.find("PubDate");
               myDoc.year = journalDate.find("Year").text();
               myDoc.month = journalDate.find("Month").text();
               myDoc.day = journalDate.find("Day").text();
               myDoc.medlinedate = journalDate.find("MedlineDate").text();
               myDoc.pages = $(this).find("MedlinePgn").text();
               $(this).find('Author').each(function(){
                 var lastname = $(this).find("LastName").text();
                 var intials = $(this).find("Initials").text();
                 authors.push(lastname + " " + intials)
               });
               myDoc.authors = authors;
               myDoc.sortstatus = "Unsorted";
               startDocs[myDoc.pmid] = myDoc;
               sieveDocs.push(myDoc.pmid);
           }
         });
        });
       }
     }
   }

   function showDoc(pmid) {
     $("#doc-display").empty();
     var myDoc = startDocs[pmid];
     $("#judge-doc").modal();
     $("#currentstatus").text(myDoc.sortstatus);
     $("#doc-display").append('<div class="sievedoc"></div>');
     $(".sievedoc").append('<h2 class="doctitle" data-pmid=' + pmid + '>' + myDoc.title + '</h2>');
     var issuestring = '<em>' + myDoc.journalTitle + '</em>';
     if (myDoc.year == "") { issuestring = issuestring + " " + myDoc.medlinedate }
     else {
       issuestring = issuestring + " " + myDoc.year + " " + myDoc.month + " " + myDoc.day;
     }
     issuestring = issuestring.trim() + "; "
     issuestring = issuestring + myDoc.volume;
     if (myDoc.issue !== "") { issuestring = issuestring + " (" + myDoc.issue + ") " }
     issuestring = issuestring.trim() + ": "
     issuestring = issuestring + myDoc.pages;
     $(".sievedoc").append('<p>' + issuestring + '</p>');
     var authorstring = myDoc.authors.join(', ');
     $(".sievedoc").append('<p>' + authorstring + '</p>');
     $(".sievedoc").append('<p>' + myDoc.abstract + '</p>');
   }

   function fetchunsorted() {
     if (sieveDocs.length > 0) {
       showDoc(sieveDocs[getRandomIntInclusive(0, sieveDocs.length-1)]);
     } else {
       setTimeout(fetchunsorted, 50);
     }
   }

   function updateLists() {
     $("#sievelist").empty();
     sieveDocs.length = 0;
     $("#goodlist").empty();
     goodDocs.length = 0;
     $("#badlist").empty();
     badDocs.length = 0;
     $("#skippedlist").empty();
     skipDocs.length = 0;
     var pmids = Object.keys(startDocs)
     for (var i=0; i<pmids.length; i++) {
       polulateLists(pmids[i], startDocs[pmids[i]].sortstatus);
     }
     $("#mehnumber").text(sieveDocs.length);
     $("#goodnumber").text(goodDocs.length);
     $("#badnumber").text(badDocs.length);
     $("#skipnumber").text(skipDocs.length);
   }

   function writeResults(search, total, good, bad) {
     $("#searchperformance").append("<tr>");
     $("#searchperformance tr:last").append("<td>" + search + "</td>");
     $("#searchperformance tr:last").append("<td>" + total + "</td>");
     $("#searchperformance tr:last").append("<td>" + good + " (" + good/total + ")</td>");
     $("#searchperformance tr:last").append("<td>" + bad + " (" + bad/total + ")</td>");
   }

   function polulateLists(pmid, status) {
     if (status == "Unsorted") {
       sieveDocs.push(pmid);
       listname = "sievelist";
     }
     if (status == "Good") {
       goodDocs.push(pmid);
       listname = "goodlist";
     }
     if (status == "Bad") {
       badDocs.push(pmid);
       listname = "badlist";
     }
     if (status == "Skipped") {
       skipDocs.push(pmid);
       listname = "skippedlist";
     }
     $("#" + listname).append('<li data-pmid=' + pmid + '>' + startDocs[pmid].title  + "</li>");
   }

   function getRandomIntInclusive(min, max) {
     min = Math.ceil(min);
     max = Math.floor(max);
     return Math.floor(Math.random() * (max - min + 1)) + min;
   }

   function onlyUnique(value, index, self) {
     return self.indexOf(value) === index;
  }


 })
 ();

</script>

  </html>
